<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0e1117">
<title>Gewitter-Z√§hler ¬∑ iPhone</title>
<style>
  :root{
    --bg:#0e1117; --panel:#121620; --panel2:#161b22;
    --accent:#7ee787; --accent2:#79c0ff; --text:#e6edf3; --muted:#9da7b3; --warn:#f2cc60; --danger:#ff7b72;
    --safe-inset-top: env(safe-area-inset-top);
    --safe-inset-bottom: env(safe-area-inset-bottom);
    --safe-inset-left: env(safe-area-inset-left);
    --safe-inset-right: env(safe-area-inset-right);
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%; margin:0; font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:var(--bg);}
  body{padding-top: calc(12px + var(--safe-inset-top)); padding-bottom: calc(12px + var(--safe-inset-bottom));}
  header{padding:0 16px 10px;}
  h1{margin:0; font-size: clamp(18px, 4.5vw, 26px); letter-spacing:.2px;}
  .sub{color:var(--muted); font-size:.95rem;}
  main{display:grid; gap:14px; padding:0 16px; max-width:820px; margin:0 auto;}
  .card{background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.07); border-radius:16px; padding:12px; box-shadow: 0 8px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06);}
  .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
  .controls{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px;}
  @media (min-width: 560px){ .controls{ grid-template-columns: repeat(3, 1fr);} }
  button{font-weight:700; font-size:1.05rem; padding:14px 16px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); color:var(--text); cursor:pointer; touch-action:manipulation;}
  button:active{transform: translateY(1px) scale(.995);}
  .accent{border-color: rgba(126,231,135,.6); box-shadow: 0 0 0 2px rgba(126,231,135,.15) inset;}
  .accent2{border-color: rgba(121,192,255,.5); box-shadow: 0 0 0 2px rgba(121,192,255,.1) inset;}
  .warn{border-color: rgba(242,204,96,.5);}
  .danger{border-color: rgba(255,123,114,.5);}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:rgba(121,192,255,.12); border:1px solid rgba(121,192,255,.28); font-weight:600;}
  .muted{color:var(--muted);}
  .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.95em; padding:.1em .45em; border-radius:6px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06);}
  canvas{display:block; width:100%; height:auto; aspect-ratio:1/1;}
  .two-col{display:grid; gap:12px;}
  @media (min-width: 900px){ .two-col{ grid-template-columns: 420px 1fr; align-items:start} }
  table{width:100%; border-collapse:collapse; font-size:.95rem;}
  th,td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.07); text-align:left; white-space:nowrap;}
  .table-wrap{overflow:auto; max-height:340px; border-radius:12px; border:1px solid rgba(255,255,255,.07);}
  footer{padding:12px 16px; text-align:center; color:var(--muted); font-size:.9rem;}
  .toast{position:fixed; left:50%; transform:translateX(-50%); bottom: calc(20px + var(--safe-inset-bottom)); background:#1b2230; border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px 14px; font-weight:600; z-index:9999;}
</style>
</head>
<body>
  <header class="row" style="justify-content:space-between">
    <div>
      <h1>Gewitter-Z√§hler <span class="sub">¬∑ iPhone</span></h1>
      <div class="sub">Touch-UI, offline ¬∑ speichert Standort nur lokal.</div>
    </div>
    <span id="badge" class="pill">‚ö° Kein aktives Gewitter</span>
  </header>

  <main class="two-col">
    <section class="card">
      <canvas id="dial" width="800" height="800" aria-label="Gewitter-Z√§hler"></canvas>
      <div class="controls">
        <button id="start" class="accent">Gewitter starten</button>
        <button id="end" class="warn">Beenden</button>
        <button id="flash" class="accent2" title="Bei Blitz tippen">‚ö° Blitz</button>
        <button id="thunder" class="accent2" title="Bei Donner tippen">üîä Donner</button>
        <button id="loc" title="Standort aktualisieren">üìç Standort</button>
        <button id="export">‚¨áÔ∏è CSV</button>
        <button id="reset" class="danger">Alles l√∂schen</button>
      </div>
      <div class="sub" style="margin-top:10px">
        Shortcuts (Mac/Hardware-Tastatur): <span class="kbd">B</span> = Blitz, <span class="kbd">D</span> = Donner
      </div>
    </section>

    <section class="card">
      <h3>Standort & Messungen</h3>
      <div id="locLine" class="sub">Standort: unbekannt ‚Äì tippe ‚Äûüìç Standort‚Äú und erlaube Zugriff.</div>

      <!-- Gro√üe Radar-Karte -->
      <iframe id="radar" src="" style="width:100%; height:350px; border:0; border-radius:12px;"></iframe>

      <!-- Thunderstorm Karte -->
      <iframe id="thunderMap" src="" style="width:100%; height:250px; border:0; border-radius:12px; margin-top:12px;"></iframe>

      <!-- Wetter -->
      <div id="weather" class="sub" style="margin-top:10px"></div>

      <div class="table-wrap" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>Zeit</th>
              <th>Ereignis</th>
              <th>Dauer (s)</th>
              <th>Entfernung (km)</th>
              <th>Lat</th>
              <th>Lon</th>
              <th>¬±m</th>
              <th>Storm-ID</th>
            </tr>
          </thead>
          <tbody id="log"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>Zum Home-Bildschirm hinzuf√ºgen f√ºr Vollbild. Daten bleiben auf deinem Ger√§t.</footer>

  <div id="toast" class="toast" style="display:none"></div>

<script>
(function(){
  const DPR = Math.max(1, window.devicePixelRatio || 1);
  const W = 800, H = 800;
  const canvas = document.getElementById('dial');
  const ctx = canvas.getContext('2d');
  canvas.width = W * DPR; canvas.height = H * DPR; ctx.scale(DPR, DPR);

  const STORAGE_KEY = "gewitter-counter-iphone-v1";

  let state = {stormsThisMonth:0, activeStormId:null, measurements:[], pendingFlashAt:null, location:{lat:null,lon:null,acc:null,t:null}, lastSaved:null};
  try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw) state=JSON.parse(raw); }catch(e){}
  const save = ()=>{ state.lastSaved=Date.now(); localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); render(); };

  const badge = document.getElementById('badge');
  const startBtn = document.getElementById('start');
  const endBtn = document.getElementById('end');
  const flashBtn = document.getElementById('flash');
  const thunderBtn = document.getElementById('thunder');
  const exportBtn = document.getElementById('export');
  const resetBtn = document.getElementById('reset');
  const locBtn = document.getElementById('loc');
  const stats = document.getElementById('stats');
  const logBody = document.getElementById('log');
  const locLine = document.getElementById('locLine');
  const toast = document.getElementById('toast');
  const radar = document.getElementById('radar');
  const thunderMap = document.getElementById('thunderMap');
  const weatherDiv = document.getElementById('weather');

  const round2=x=>Math.round(x*100)/100;
  const fmtTime=t=>new Date(t).toLocaleString();
  function showToast(text){ toast.textContent=text; toast.style.display="block"; setTimeout(()=>toast.style.display="none",1600); }

  const anim = {shown:0};
  function draw(){
    const cx=W/2,cy=H/2,r=280;
    ctx.clearRect(0,0,W,H);
    ctx.beginPath();
    const grad = ctx.createRadialGradient(cx,cy,0,cx,cy,r*1.1);
    grad.addColorStop(0,"rgba(126,231,135,.07)");
    grad.addColorStop(1,"rgba(126,231,135,.01)");
    ctx.fillStyle=grad; ctx.arc(cx,cy,r*1.25,0,Math.PI*2); ctx.fill();

    ctx.lineWidth=18; ctx.strokeStyle="rgba(255,255,255,.08)";
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();

    const maxVisual=20;
    const frac=Math.min(1,(anim.shown%(maxVisual+1))/maxVisual);
    const ringGrad=ctx.createLinearGradient(cx-r,cy-r,cx+r,cy+r);
    ringGrad.addColorStop(0,"rgba(126,231,135,.9)");
    ringGrad.addColorStop(1,"rgba(121,192,255,.9)");
    ctx.strokeStyle=ringGrad; ctx.lineCap="round";
    ctx.beginPath(); ctx.arc(cx,cy,r,-Math.PI/2,-Math.PI/2+frac*Math.PI*2); ctx.stroke();

    if(state.activeStormId){ ctx.shadowColor="rgba(126,231,135,.6)"; ctx.shadowBlur=24; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke(); ctx.shadowBlur=0; }

    ctx.fillStyle="#e6edf3"; ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.font="700 92px system-ui,-apple-system,Segoe UI,Roboto"; ctx.fillText(String(state.stormsThisMonth),cx,cy-10);
    ctx.font="600 20px system-ui,-apple-system,Segoe UI,Roboto";
    const hint=state.pendingFlashAt?"Z√§hle bis Donner ‚Ä¶":(state.activeStormId?"Bereit":"Keine Session");
    ctx.fillStyle=state.pendingFlashAt?"rgba(242,204,96,.95)":"rgba(157,167,179,.95)";
    ctx.fillText("Gewitter diesen Monat",cx,cy+36);
    ctx.fillText(hint,cx,cy+64);
  }
  function animate(){ const target=state.stormsThisMonth; anim.shown+=(target-anim.shown)*0.15; if(Math.abs(target-anim.shown)<0.01) anim.shown=target; draw(); requestAnimationFrame(animate); }
  animate();

  let watchId=null;
  function requestLocation(){
    if(!('geolocation' in navigator)){ showToast("Kein Geolocation-Support"); return; }
    if(watchId!=null) navigator.geolocation.clearWatch(watchId);
    watchId=navigator.geolocation.watchPosition(pos=>{
      const {latitude,longitude,accuracy}=pos.coords;
      state.location={lat:latitude,lon:longitude,acc:Math.round(accuracy),t:Date.now()};
      save(); updateLocLine();
    },err=>{ console.warn(err); showToast(err.message || "Standortfehler"); updateLocLine(); }, {enableHighAccuracy:true,maximumAge:15000,timeout:15000});
    showToast("Standort wird aktualisiert ‚Ä¶");
  }

  function updateLocLine(){
    if(!state.location.lat){ locLine.textContent="Standort: unbekannt ‚Äì tippe ‚Äûüìç Standort‚Äú und erlaube Zugriff."; return; }
    const {lat,lon,acc,t}=state.location;
    locLine.textContent=`Standort: ${round2(lat)}¬∞, ${round2(lon)}¬∞ (¬±${acc ?? "?"} m) ¬∑ ${t?new Date(t).toLocaleTimeString():""}`;
    radar.src=`https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&detailLat=${lat}&detailLon=${lon}&width=650&height=350&zoom=5&level=surface&overlay=lightning&menu=&message=true&marker=true&calendar=now&pressure=false&type=map&location=coordinates&detail=true&metricWind=km%2Fh&metricTemp=%C2%B0C&radarRange=-1`;
    thunderMap.src=`https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&width=650&height=250&zoom=5&level=surface&overlay=thunder&menu=&message=true&marker=true&calendar=now&type=map&location=coordinates`;
    fetch(`https://wttr.in/${lat},${lon}?format=%C+%t+%w+%h&lang=de`).then(r=>r.text()).then(t=>{weatherDiv.textContent=t;});
  }

  function currentLocFields(){ const {lat,lon,acc}=state.location||{}; return {lat,lon,acc}; }
  function startStorm(){ if(state.activeStormId) return; const id="S"+Date.now().toString(36); state.activeStormId=id; state.stormsThisMonth+=1; state.measurements.unshift({t:Date.now(),type:"storm_start",stormId:id,...currentLocFields()}); save(); showToast("Session gestartet"); }
  function endStorm(){ if(!state.activeStormId) return; state.measurements.unshift({t:Date.now(),type:"storm_end",stormId:state.activeStormId,...currentLocFields()}); state.activeStormId=null; state.pendingFlashAt=null; save(); showToast("Session beendet"); }
  function flash(){ if(!state.activeStormId) startStorm(); state.pendingFlashAt=Date.now(); state.measurements.unshift({t:state.pendingFlashAt,type:"flash",stormId:state.activeStormId,...currentLocFields()}); save(); }
  function thunder(){ if(!state.pendingFlashAt) return; const t=Date.now(); const deltaSec=(t-state.pendingFlashAt)/1000; const km=deltaSec/3; state.measurements.unshift({t,type:"thunder",deltaSec:round2(deltaSec),km:round2(km),stormId:state.activeStormId,...currentLocFields()}); state.pendingFlashAt=null; save(); }

  startBtn.addEventListener('click',startStorm);
  endBtn.addEventListener('click',endStorm);
  flashBtn.addEventListener('click',flash);
  thunderBtn.addEventListener('click',thunder);
  exportBtn.addEventListener('click',()=>{
    const rows=[["Zeit","Ereignis","Dauer (s)","Entfernung (km)","Lat","Lon","¬±m","Storm-ID"]];
    state.measurements.slice().reverse().forEach(m=>rows.push([fmtTime(m.t), m.type==="flash"?"Blitz":(m.type==="thunder"?"Donner":(m.type==="storm_start"?"Start":"Ende")), m.deltaSec??"", m.km??"", m.lat??"", m.lon??"", m.acc??"", m.stormId??""]));
    const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="gewitter_messungen.csv"; a.click(); URL.revokeObjectURL(a.href);
  });
  resetBtn.addEventListener('click',()=>{ if(!confirm("Wirklich alle Daten l√∂schen?")) return; state={stormsThisMonth:0,activeStormId:null,measurements:[],pendingFlashAt:null,location:{lat:null,lon:null,acc:null,t:null},lastSaved:null}; save(); showToast("Alle Daten gel√∂scht"); });
  locBtn.addEventListener('click',requestLocation);

  document.addEventListener('keydown',e=>{ if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA") return; if(e.key.toLowerCase()==="b") flash(); if(e.key.toLowerCase()==="d") thunder(); });

  function render(){ logBody.innerHTML=""; state.measurements.forEach(m=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${fmtTime(m.t)}</td><td>${m.type}</td><td>${m.deltaSec??""}</td><td>${m.km??""}</td><td>${m.lat??""}</td><td>${m.lon??""}</td><td>${m.acc??""}</td><td>${m.stormId??""}</td>`; logBody.appendChild(tr); }); badge.textContent=state.activeStormId?"‚ö° Gewitter aktiv":"‚ö° Kein aktives Gewitter"; updateLocLine(); }
  render();
})();
</script>
</body>
</html>
