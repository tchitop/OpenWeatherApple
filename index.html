<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0e1117">
<title>Gewitter-ZÃ¤hler Â· iPhone</title>
<link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Gewitter-ZÃ¤hler&quot;,&quot;short_name&quot;:&quot;Gewitter&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#0e1117&quot;,&quot;theme_color&quot;:&quot;#0e1117&quot;,&quot;icons&quot;:[]}">
<style>
/* ... Dein bisheriger CSS-Code bleibt unverÃ¤ndert ... */
.map iframe{width:100%; height:220px; border:none; border-radius:12px;}
.weather-box{margin-top:12px; font-size:.95rem;}
</style>
</head>
<body>
  <header class="row" style="justify-content:space-between">
    <div>
      <h1>Gewitter-ZÃ¤hler <span class="sub">Â· iPhone</span></h1>
      <div class="sub">Touch-UI, offline Â· speichert Standort nur lokal.</div>
    </div>
    <span id="badge" class="pill">âš¡ Kein aktives Gewitter</span>
  </header>

  <main class="two-col">
    <section class="card">
      <canvas id="dial" width="800" height="800" aria-label="Gewitter-ZÃ¤hler"></canvas>

      <div class="controls">
        <button id="start" class="accent">Gewitter starten</button>
        <button id="end" class="warn">Beenden</button>
        <button id="flash" class="accent2" title="Bei Blitz tippen">âš¡ Blitz</button>
        <button id="thunder" class="accent2" title="Bei Donner tippen">ğŸ”Š Donner</button>
        <button id="loc" title="Standort aktualisieren">ğŸ“ Standort</button>
        <button id="export">â¬‡ï¸ CSV</button>
        <button id="reset" class="danger">Alles lÃ¶schen</button>
      </div>

      <div class="sub" style="margin-top:10px">
        Shortcuts (Mac/Hardware-Tastatur): <span class="kbd">B</span> = Blitz, <span class="kbd">D</span> = Donner
      </div>
    </section>

    <section class="card">
      <h3 style="margin:6px 0 6px">Standort & Messungen</h3>
      <div id="locLine" class="sub">Standort: unbekannt â€“ erlaube â€Standort verwendenâ€œ.</div>

      <!-- Echtzeit-Blitzkarte -->
      <div class="map" id="mapBox" aria-label="Blitzradar">
        <div id="dot" class="dot" style="display:none"></div>
        <iframe id="radarFrame" src="" allowfullscreen></iframe>
      </div>

      <!-- Wetter-Box -->
      <div id="weatherBox" class="weather-box sub">Wetterdaten werden geladen â€¦</div>

      <div class="table-wrap" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>Zeit</th>
              <th>Ereignis</th>
              <th>Dauer (s)</th>
              <th>Entfernung (km)</th>
              <th>Lat</th>
              <th>Lon</th>
              <th>Â±m</th>
              <th>Storm-ID</th>
            </tr>
          </thead>
          <tbody id="log"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>Zum Home-Bildschirm hinzufÃ¼gen fÃ¼r Vollbild. Daten bleiben auf deinem GerÃ¤t.</footer>

  <div id="toast" class="toast" style="display:none"></div>

<script>
(function(){
  const DPR = Math.max(1, window.devicePixelRatio || 1);
  const W = 800, H = 800;
  const canvas = document.getElementById('dial');
  const ctx = canvas.getContext('2d');
  canvas.width = W * DPR; canvas.height = H * DPR; ctx.scale(DPR, DPR);

  const STORAGE_KEY = "gewitter-counter-iphone-v1";
  let state = {stormsThisMonth:0, activeStormId:null, measurements:[], pendingFlashAt:null, location:{lat:null,lon:null,acc:null,t:null}, lastSaved:null};
  try{ const raw = localStorage.getItem(STORAGE_KEY); if (raw) state = JSON.parse(raw); }catch(e){}
  const save = () => { state.lastSaved = Date.now(); localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); render(); };

  const badge = document.getElementById('badge');
  const startBtn = document.getElementById('start');
  const endBtn = document.getElementById('end');
  const flashBtn = document.getElementById('flash');
  const thunderBtn = document.getElementById('thunder');
  const exportBtn = document.getElementById('export');
  const resetBtn = document.getElementById('reset');
  const locBtn = document.getElementById('loc');
  const stats = document.getElementById('stats');
  const logBody = document.getElementById('log');
  const locLine = document.getElementById('locLine');
  const toast = document.getElementById('toast');
  const radarFrame = document.getElementById('radarFrame');
  const weatherBox = document.getElementById('weatherBox');

  const round2 = x => Math.round(x*100)/100;
  const fmtTime = t => new Date(t).toLocaleString();
  function showToast(text){ toast.textContent = text; toast.style.display="block"; setTimeout(()=> toast.style.display="none", 1600); }

  // Canvas Dial (bleibt unverÃ¤ndert)
  const anim = { shown: 0 };
  function draw(){ /* ... wie vorher ... */ }
  function animate(){ anim.shown += (state.stormsThisMonth - anim.shown) * 0.15; draw(); requestAnimationFrame(animate); }
  animate();

  /*** LOCATION ***/
  let watchId = null;
  function updateLocLine(){
    if (state.location.lat==null){ locLine.textContent = "Standort: unbekannt â€“ tippe â€ğŸ“ Standortâ€œ und erlaube Zugriff."; return; }
    const {lat,lon,acc,t} = state.location;
    locLine.textContent = `Standort: ${round2(lat)}Â°, ${round2(lon)}Â° (Â±${acc ?? "?"} m) Â· ${t ? new Date(t).toLocaleTimeString() : ""}`;
    updateRadar(lat, lon);
    updateWeather(lat, lon);
  }
  function placeDot(){ /* ... unverÃ¤ndert ... */ }

  function requestLocation(){
    if (!('geolocation' in navigator)){ showToast("Kein Geolocation-Support"); return; }
    const opts = {enableHighAccuracy:true, maximumAge: 15000, timeout: 15000};
    if (watchId!=null){ navigator.geolocation.clearWatch(watchId); }
    watchId = navigator.geolocation.watchPosition((pos)=>{
      const {latitude, longitude, accuracy} = pos.coords;
      state.location = {lat: latitude, lon: longitude, acc: Math.round(accuracy), t: Date.now()};
      save(); updateLocLine(); placeDot();
    }, (err)=>{ showToast(err.message || "Standortfehler"); updateLocLine(); }, opts);
    showToast("Standort wird aktualisiert â€¦");
  }
  locBtn.addEventListener('click', requestLocation);

  /*** Radar & Wetter ***/
  function updateRadar(lat, lon){
    // Windy / Blitzradar
    const zoom = 6;
    radarFrame.src = `https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&detailLat=${lat}&detailLon=${lon}&zoom=${zoom}&level=surface&overlay=lightning&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1`;
  }
  function updateWeather(lat, lon){
    // wttr.in JSON
    fetch(`https://wttr.in/${lat},${lon}?format=%C+%t+%w+%h+%m&lang=de`)
      .then(r=>r.text()).then(t=>{ weatherBox.textContent = "Wetter: "+t; })
      .catch(()=> weatherBox.textContent = "Wetterdaten nicht verfÃ¼gbar");
  }

  /*** Storm logic, Events & Render wie vorher ... */
  // flash, thunder, startStorm, endStorm, render() usw. bleiben wie bisher

  setTimeout(()=>{ requestLocation(); }, 500);
})();
</script>
</body>
</html>
